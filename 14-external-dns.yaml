apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-dns
  namespace: mongo-stack
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: external-dns
rules:
  - apiGroups: [""]
    resources: ["services", "endpoints", "pods"]
    verbs: ["get", "watch", "list"]
  - apiGroups: ["networking.k8s.io"]
    resources: ["ingresses"]
    verbs: ["get", "watch", "list"]
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: external-dns-viewer
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: external-dns
subjects:
  - kind: ServiceAccount
    name: external-dns
    namespace: mongo-stack
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: external-dns
  namespace: mongo-stack
spec:
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: external-dns
  template:
    metadata:
      labels:
        app: external-dns
    spec:
      serviceAccountName: external-dns
      containers:
        - name: external-dns
          image: k8s.gcr.io/external-dns/external-dns:v0.14.2
          args:
            - --source=ingress                   # Monitor ingress resources
            - --domain-filter=yourdomain.com     # Your domain name
            - --provider=azure                   # Use Azure DNS
            - --azure-resource-group=MyDNSRG     # Azure resource group containing DNS zone
            - --azure-subscription-id=<SUB_ID>   # Azure subscription ID
            - --azure-tenant-id=<TENANT_ID>      # Azure tenant ID
            - --azure-client-id=<CLIENT_ID>      # Azure service principal client ID
            - --azure-client-secret=<CLIENT_SECRET> # Azure service principal secret
            - --registry=txt
            - --txt-owner-id=mongo-stack
            - --policy=sync                      # Keep DNS records synced
          env:
            - name: AZURE_ENVIRONMENT_FILEPATH
              value: /etc/kubernetes/azure.json
          volumeMounts:
            - name: azure-config
              mountPath: /etc/kubernetes
              readOnly: true
      volumes:
        - name: azure-config
          secret:
            secretName: azure-config-file  # Store azure.json credentials here
